<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>WaveWriter.as</title>
<link rel="stylesheet" type="text/css" href="../../../../../SourceStyles.css"/>
</head>

<body><pre><span class="ActionScriptpackage">package</span> <span class="ActionScriptDefault_Text">com</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">increpare</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">bfxr</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">synthesis</span>
<span class="ActionScriptBracket/Brace">{</span>        
<span class="ActionScriptComment">/*
    class by henke37, 
    from http://webcache.googleusercontent.com/search?q=cache:bx2VN_2MqUwJ:www.actionscript.org/forums/showthread.php3%3Ft%3D248418+0x666D7420+floating+point&amp;cd=1&amp;hl=en&amp;ct=clnk&amp;gl=uk&amp;source=www.google.co.uk
    */</span>
    
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">utils</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;
    
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">WaveWriter</span> <span class="ActionScriptBracket/Brace">{</span>
        
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">outBuffer</span>:<span class="ActionScriptDefault_Text">ByteArray</span>;
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stereo</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">true</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">sampleRate</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">=</span>44100;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bitsPerSample</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">=</span>32;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">useFloat</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">true</span>;
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">writePointer</span>:<span class="ActionScriptDefault_Text">uint</span>;
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">riffSizePointer</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">dataSizePointer</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">factSamplesPointer</span>:<span class="ActionScriptDefault_Text">uint</span>;
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">WaveWriter</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stereo</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptOperator">,</span><span class="ActionScriptDefault_Text">bits</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">=</span>32<span class="ActionScriptOperator">,</span><span class="ActionScriptDefault_Text">b</span>:<span class="ActionScriptDefault_Text">ByteArray</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
            
            <span class="ActionScriptReserved">this</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">stereo</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">stereo</span>;
            <span class="ActionScriptDefault_Text">bitsPerSample</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">bits</span>;
            <span class="ActionScriptDefault_Text">useFloat</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">bits</span><span class="ActionScriptOperator">&gt;=</span>32;
            
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">b</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">b</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptDefault_Text">writeWAVEHeader</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
            
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">writeWAVEHeader</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">endian</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">Endian</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">BIG_ENDIAN</span>;
            
            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span>0x52494646<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//riff marker
</span>            
            <span class="ActionScriptDefault_Text">riffSizePointer</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span>;
            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//Size, to be filled in later
</span>            
            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span>0x57415645<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//wave marker
</span>            
            <span class="ActionScriptComment">//write the fmt  chunk now
</span>            
            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span>0x666D7420<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//fmt marker
</span>            
            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">endian</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">Endian</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">LITTLE_ENDIAN</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bytesPerSample</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">bitsPerSample</span><span class="ActionScriptOperator">/</span>8;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">blockSize</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">=</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stereo</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">bytesPerSample</span>;
            
            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">useFloat</span><span class="ActionScriptOperator">?</span><span class="ActionScriptBracket/Brace">(</span>22<span class="ActionScriptOperator">+</span>2<span class="ActionScriptBracket/Brace">)</span>:0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">+</span>16<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//length of the chunk
</span>            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">useFloat</span><span class="ActionScriptOperator">?</span>0xFFFE:1<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//compression, uncompressed PCM or extended wave
</span>            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stereo</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//channel count
</span>            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sampleRate</span><span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//samplerate
</span>            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sampleRate</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">blockSize</span><span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//ByteRate
</span>            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">blockSize</span><span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//Block align
</span>            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bitsPerSample</span><span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//bits per sample
</span>            
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">useFloat</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span>22<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//Extra data length
</span>                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bitsPerSample</span><span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//valid bits per sample
</span>                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span>3<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//channel order flag field thingy
</span>                
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span>0x0003<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//real type, float
</span>                
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span>0x0000<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//rest of GUID
</span>                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span>0x0010<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span>0x80<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span>0x00<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span>0x00<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span>0xaa<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span>0x00<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span>0x38<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span>0x9b<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span>0x71<span class="ActionScriptBracket/Brace">)</span>;
                
                <span class="ActionScriptComment">//fact chunk
</span>                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">endian</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">Endian</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">BIG_ENDIAN</span>;
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span>0x66616374<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//fact marker
</span>                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">endian</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">Endian</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">LITTLE_ENDIAN</span>;
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span>4<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//chunk length, not counting the header
</span>                <span class="ActionScriptDefault_Text">factSamplesPointer</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span>
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span>1<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//number of sample pairs, to be filled in later
</span>            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptComment">//write the data chunk now
</span>            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">endian</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">Endian</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">BIG_ENDIAN</span>;
            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span>0x64617461<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//data marker
</span>            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">endian</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">Endian</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">LITTLE_ENDIAN</span>;
            
            <span class="ActionScriptDefault_Text">dataSizePointer</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span>;
            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//Size, to be filled in later
</span>            
            <span class="ActionScriptDefault_Text">writePointer</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span>;
            
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">finalize</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>: <span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">dataLength</span> <span class="ActionScriptOperator">%</span> 2 <span class="ActionScriptOperator">==</span> 1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptComment">//add one byte of padding to the data block, if needed
</span>                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">writePointer</span>;
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">writePointer</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">updateSizeFields</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/** position difference from begining of data tag to end of data,
         not counting the size field itself
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">dataLength</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">writePointer</span><span class="ActionScriptOperator">-</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">dataSizePointer</span><span class="ActionScriptOperator">+</span>4<span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">updateSizeFields</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">//update length values that's not been updated during bulk writing
</span>            
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">sampleByteLength</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">dataLength</span>;
            
            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">endian</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">Endian</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">LITTLE_ENDIAN</span>;
            
            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">riffSizePointer</span>;
            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">-</span>8<span class="ActionScriptBracket/Brace">)</span>;<span class="ActionScriptComment">//RIFF header does not count in the RIFF header
</span>            
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">useFloat</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">factSamplesPointer</span>;
                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sampleByteLength</span><span class="ActionScriptOperator">/</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bitsPerSample</span><span class="ActionScriptOperator">/</span>8<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">dataSizePointer</span>;
            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeUnsignedInt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sampleByteLength</span><span class="ActionScriptBracket/Brace">)</span>;
            
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">addSamples</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sb</span>:<span class="ActionScriptDefault_Text">ByteArray</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">writePointer</span>;
            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">endian</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">Endian</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">LITTLE_ENDIAN</span>;
            
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stereo</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">useFloat</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">bitsPerSample</span><span class="ActionScriptOperator">==</span>32 <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">sb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">endian</span><span class="ActionScriptOperator">==</span><span class="ActionScriptDefault_Text">Endian</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">LITTLE_ENDIAN</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">//endianness missmatch prevents a fast copy
</span>                <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sb</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stereo</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>   
                <span class="ActionScriptReserved">while</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">sb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">left</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">sb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">readFloat</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">right</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">sb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">readFloat</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
                    
                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">useFloat</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bitsPerSample</span><span class="ActionScriptOperator">==</span>32<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeFloat</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">left</span><span class="ActionScriptBracket/Brace">)</span>;
                            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeFloat</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">right</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptComment">//assume 64 bit
</span>                            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeDouble</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">left</span><span class="ActionScriptBracket/Brace">)</span>;
                            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeDouble</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">right</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                        
                        <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bitsPerSample</span><span class="ActionScriptOperator">==</span>8<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                            <span class="ActionScriptComment">//scale to unsigned byte
</span>                            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">numberTo8bit</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">left</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;
                            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">numberTo8bit</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">right</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptComment">//assume signed 16 bit
</span>                            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">numberTo16bit</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">left</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;
                            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">numberTo16bit</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">right</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptBracket/Brace">}</span><span class="ActionScriptComment">//end if use float
</span>                <span class="ActionScriptBracket/Brace">}</span><span class="ActionScriptComment">//end while
</span>            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptComment">// mono
</span>                <span class="ActionScriptReserved">while</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">sb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">left</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">sb</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">readFloat</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
                    
                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">useFloat</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bitsPerSample</span><span class="ActionScriptOperator">==</span>32<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeFloat</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">left</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptComment">//assume 64 bit
</span>                            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeDouble</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">left</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                        
                        <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bitsPerSample</span><span class="ActionScriptOperator">==</span>8<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                            <span class="ActionScriptComment">//scale to unsigned byte
</span>                            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">numberTo8bit</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">left</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptComment">//assume signed 16 bit
</span>                            <span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">numberTo16bit</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">left</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptBracket/Brace">}</span><span class="ActionScriptComment">//end if useFloat
</span>                <span class="ActionScriptBracket/Brace">}</span><span class="ActionScriptComment">//end while
</span>            <span class="ActionScriptBracket/Brace">}</span><span class="ActionScriptComment">//end if mono
</span>            <span class="ActionScriptDefault_Text">writePointer</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">outBuffer</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">numberTo8bit</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">x</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">x</span><span class="ActionScriptOperator">*</span>128<span class="ActionScriptOperator">+</span>127;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">numberTo16bit</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">x</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">*</span> 32767 <span class="ActionScriptOperator">+</span>0.5<span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptBracket/Brace">}</span>
<span class="ActionScriptBracket/Brace">}</span></pre></body>
</html>
